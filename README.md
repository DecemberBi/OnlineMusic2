# OnlineMusic2
这是一个搜索歌曲，下载歌曲，播放歌曲的小程序。是项目中的一个子功能模块。程序非常简单只有一个界面，功能简单明了在搜索栏中输入想搜的信息，点击搜索按钮下方ListView便列出搜索结果。中间一排歌曲按钮，可以前后选择歌曲，播放暂停歌曲。


## 搜索歌曲
搜索歌曲为网络操作相对耗时，这里当用户点击搜索时显示一个搜索进度框，并新建一个新线程开始调用搜索歌曲助手类。在调用搜索歌曲助手类的同时传入一个回调函数，当搜索歌曲助手类方法执行成功或失败都会通过回调函数返回结果，当成功时把搜索结果返回并用Message的sendMessage方法来修改UI（把搜索结果显示给ViewList）。
这里用到了android的多线程和用回调函数的网络编程，可以参考下面两篇博客：
[Android 多线程 - 异步消息处理机制](http://blog.csdn.net/nikaihua008/article/details/64126716)
[android 网络编程 - HttpURLConnection与HttpClient](http://blog.csdn.net/nikaihua008/article/details/62230821#t6)


### Volley
如果打开上面第二条链接的朋友会发现，链接里讲了HttpURLConnection和HttpClient，而在项目中没有这两个类的影子。项目中使用的是Volley，这玩意是Google自己的一个网络库，底层代码还是HttpURLConnection和HttpClient，很好的支持了高并发，但对于大文件的下载表现很差。
项目中我们把Volley封装在了一个单例类中。这里采用了饿汉式单例。

运用Volley进行网络请求的过程相当简单。主要分下面三步骤：
1.  创建一个RequestQueue对象。
2.  创建一个Request对象。
3.  将Request对象添加到RequestQueue里面。


## 下载歌曲
下载歌曲分两部分，一部分是保存到数据库中（用于显示播放历史记录），一部分是下载到手机中。
当用户点击歌曲时首先会判断歌曲是否在数据库中，如果在数据中表示之前播放过此歌即下载过此歌那么就会播放本地歌曲；如果在数据库中没有该歌曲则在线播放歌曲同时把歌曲保存到数据库中同时下载到本地。考虑到手机容量限制，最多保存50首歌曲。所以在保存歌曲前会先去数据库和本地删除第51首歌曲（如果有51首的话）。
这里用到了SQLiteOpenHelpr抽象类，实现了该抽象类用来作为数据库助手类。

## 操作歌曲
播放歌曲这种后台操作放到了Service中。由于用户会播放不同歌曲，每次播放不同歌曲会传递不同的歌曲地址，如果用StartService需要每次都在Intent上绑定不同的值 而且会不断的去StartService，所以采用了BindService来绑定服务。只需要一次绑定后获得自定义Service中定义的bind对象就能方便的操作Service中的定义的方法从而操作歌曲。

操作歌曲用到了MediaPlayer对象。在播放歌曲方法中首先判断用户点击是不是之前的歌曲，如果是同一首歌则判断播放状态如果在播放中就暂停播放如果在暂停状态就播放歌曲，如果不是同一首歌先设置空闲状态，再调用setDataSource方法设置歌曲资源，然后调用prepare装载音频。用这样的方式来播放下一首歌可以减少内存消耗（如果用静态方法create，每次会返回新创建的MediaPlayer对象。）
